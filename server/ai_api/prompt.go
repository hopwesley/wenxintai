package ai_api

import (
	"fmt"
	"strings"
)

//TODO:优化提示词的使用和管理。

type TestTyp string

const (
	TypUnknown TestTyp = "Unknown"
	TypRIASEC  TestTyp = "RIASEC"
	TypOCEAN   TestTyp = "OCEAN"
	TypSEC     TestTyp = "ASC"

	DefaultModel  = "deepseek-chat"
	DefaultApiUrl = "https://api.deepseek.com"

	DefaultMaxQToken = 8000
	DefaultMaxRToken = 4000
)

func genUserPrompt(bi *BasicInfo) string {
	return fmt.Sprintf("请以 json 对象数组返回，仅输出合法 json：\n"+
		"request_id: %s\n"+
		"学生基本信息：年级：%s。\n"+
		"选科模式：%s。\n"+
		"**学生兴趣因子：%s**。\n"+
		"请严格遵循 systemPrompt 的数量、结构和维度覆盖要求，"+
		"【兴趣因子使用约束】\n"+
		"- 兴趣因子仅作为“场景种子”，用于派生校园语境，不得直接作为心理学变量。\n"+
		"- 允许：将兴趣因子转化为典型校园场景，再结合学习/社交/任务行为形成题干。\n"+
		"  例如：篮球 → 体育课/课余锻炼 → 团队合作、专注力\n"+
		"        音乐 → 社团/艺术节表演 → 坚持练习、表现焦虑\n"+
		"- 禁止：直接硬写兴趣因子或将其作为考察对象。\n"+
		"  不合理示例：'我在篮球比赛失利后容易焦虑'（错误：把篮球当成心理变量）\n"+
		"  合理示例：'我喜欢在体育课上积极参与团队合作活动'（场景为篮球引申的体育课，主体为团队合作行为）\n"+
		"- 出现频率：兴趣因子衍生的场景题目最多4题，且不得在同一维度/学科中连续出现。如果兴趣与当前模块不匹配，则兴趣因子可以不生成题目\n"+
		"- 如果未提供兴趣因子，则全部使用通用校园场景。\n",
		bi.PublicId, bi.Grade, bi.Mode, bi.Hobby)
}

func getTemperature(module TestTyp) float64 {
	switch module {
	case TypOCEAN:
		return 0.8 // 稍高，鼓励创意和多样性
	case TypRIASEC:
		return 0.7 // 中等，平衡稳定与多样性
	case TypSEC:
		return 0.6 // 稍低，确保结构准确性和一致性
	default:
		return 0.75 // 默认值
	}
}

var SuperQuestions = []map[string]interface{}{
	{
		"id":        "Super-1",
		"module":    "Super",
		"dimension": "Values",
		"type":      "sort", // 固定：排序题
		"text":      "请从以下5个核心价值中选出最重要的3个并排序",
		"options":   []string{"成就感", "经济回报", "社会利他", "独立性", "创造性"},
		"reverse":   false,
	},
	{
		"id":        "Super-2",
		"module":    "Super",
		"dimension": "Values",
		"type":      "single", // 固定：单选题
		"text":      "请从上题选出的3个价值观中，选择1个‘无论如何都不能放弃’的核心锚点",
		"options":   []string{"成就感", "经济回报", "社会利他", "独立性", "创造性"},
		"reverse":   false,
	},
}

var systemPromptHeader = `
【身份与任务】
你是融合心理学权威理论与AI算法的《新高考科学选科决策支持平台》系统。你的目标：基于霍兰德职业兴趣理论（RIASEC）和大五人格模型（OCEAN），
为中国高中学生及其家长设计一份科学有效、文化适配的综合选科测评问卷。题目需参考标准量表（如BFI-20和RIASEC SDS）进行本土化改编，
最终支持《选科战略分析报告》，为科目组合（偏文、偏理、偏工、偏艺）提供科学推荐参考。
`

var systemPromptASC = systemPromptHeader + `
【学科自我概念量表（24题）】
- 参考 SDQ-III 框架，旨在测量学生对核心高考选考科目的能力信心和表现认知。
- 覆盖 6 个高考科目（物理、化学、生物、地理、历史、政治），每个学科生成 4 道题，共 24 道题。
- 每个学科固定为 3 道正向题 + 1 道反向题，且反向题必须标明 reverse:true。
- **题目分配**：每个学科的 4 道题必须覆盖以下四个维度：  
  1. Comparison：与同伴比较的能力自信  
  2. Efficacy：完成学习任务的效能感  
  3. AchievementExpectation：对学业成就的预期  
  4. SkillMastery（反向题）：对特定技能掌握的信心  

【行为要求】 
- 必须体现中国高一学生的考试导向学习现状，但只能通过学习任务和成就目标来体现，禁止直接描述情绪体验。  
- **Efficacy 维度动词限制**：
    - 允许：解答、记忆、完成、分析、计算、识别、复述、操作  
    - 禁止：建模、论证、批判、反思、评价  
- **AchievementExpectation 多样性要求**：
    - 必须体现多样化，不得重复“取得高分”“获得好成绩”。  
    - 允许范围：课堂表现、阶段性测验、综合题掌握、学科竞赛、全年级相对位置等。

【反向题规则（SkillMastery）】
- 反向题必须围绕各学科常见的学习方法或技能差异，采用“更偏好…而不是…”、“倾向于…而非…”的稳定偏好/习惯表达。  
- 鼓励体现认知层次的对比（如记忆vs理解、接受vs批判）。  
- **逻辑方向要求**：反向题必须体现对低水平或低阶学习方式的偏好，高水平或高阶学习方式只能出现在被否定的一侧。  
 例如：  
   - 正确：更偏好死记硬背公式，而不是通过实验理解原理。  
   - 错误：更偏好通过实验理解原理，而不是仅死记公式。  
 禁止：使用“困难”“出错”“不擅长”“不太倾向”“相对较少”等负性措辞。 



【输出格式要求】
- subject 字段必须使用以下编码：  
  PHY=物理, CHE=化学, BIO=生物, GEO=地理, HIS=历史, POL=政治  
- 题目输出 JSON 对象，包含以下字段：  
  {
    "id": "int",              
    "subject": "PHY" | "CHE" | "BIO" | "GEO" | "HIS" | "POL", 
    "subject_label": "string",  
    "text": "string",         
    "reverse": true | false,  
    "subtype": "Comparison" | "Efficacy" | "AchievementExpectation" | "SkillMastery"
  }
`

var systemPromptOCEAN = systemPromptHeader + `
【OCEAN 大五人格（20题）】
- 基于 BFI-20 框架：5 个维度（O/C/E/A/N）各 4 题，共 20 题。
- **严格约束**：每个维度仅允许 1 道反向题（reverse:true），其余 3 道必须为正向题。
- 聚焦学习风格、学习态度、同伴交往与心理适应。题目需以高中学习和校园生活为主要语境（如课堂、作业、同伴关系、考试压力），可适度包含一般性人格行为以保持心理学有效性。
- **多样性要求**：同一维度下的 4 道题目必须从不同角度反映该特质，涵盖多种典型校园情境（如课堂学习、作业管理、小组合作、考试应对、社团活动、同伴关系等），必须确保场景分布均衡，不得全部出现在同一语境。

【反向题规则】
- 反向题是**同一维度的低水平表征**，不得跨维度。
- 维度对照示例：
  - O（开放性）：正向=喜欢尝试新方法（课堂创新） → 反向=偏好固定、传统方式
  - C（尽责性）：正向=有计划、守时（作业完成） → 反向=容易拖延、缺乏条理（禁社交/E）
  - E（外向性）：正向=喜欢与人互动（小组参与） → 反向=更倾向独处、较少参与（禁“计划/管理”C动词）
  - A（宜人性）：正向=乐于合作、体贴（冲突调解） → 反向=更倾向坚持自我、不易妥协（禁E“主动社交”）
  - N（神经质）：正向=容易感到压力（考试反应） → 反向=通常保持情绪平稳（禁病理/身体如头痛）
- 表达：使用“较少/不太倾向/通常不”等自然表述；**禁止**“讨厌/不感兴趣”等强否定。
- 反向题应保持与正向题相同的行为类型，仅在倾向强度上反转，不得变更行为内容。

【维度校园表现】
- O（开放性）：课堂新方法尝试、作业创新解法、多样化兴趣探索
- C（尽责性）：学习计划制定、作业按时完成、考试准备条理  
- E（外向性）：课堂主动发言、小组合作参与、社团活动投入
- A（宜人性）：同伴冲突调解、团队合作支持、他人需求关注
- N（神经质）：考试压力反应、批评接受程度、变化适应能力

【维度边界提示】
- C（尽责性）题干应聚焦自我管理与任务完成；禁止涉及外向性（社交）或焦虑性（情绪紧张）。
- E（外向性）题干聚焦互动与表达；禁止出现“计划”“安排”“管理”等C特征动词。
- A（宜人性）聚焦合作与体贴；不得与E的“社交主动”混用。
- N（神经质）聚焦压力感受与情绪波动；禁止使用明显病理化或身体反应类表述（如“头痛”“失眠”“焦虑症”等）。

【JSON 格式示例】
{
  "id": "int",              // 题号
  "dimension": "O" | "C" | "E" | "A" | "N", 
  "text": "string",            // 中文题干
  "reverse": false             // 是否为反向题: true | false
}
`

var systemPromptRIASEC = systemPromptHeader + `
【RIASEC 基础题（30题）】
- 6 个维度（R/I/A/S/E/C）各 5 题，共 30 题。
- 全部为正向兴趣题，不得设计反向题。
- 测量核心：兴趣 = 对活动的喜好/吸引力，而非能力水平、参与频率或情绪体验。

【专属约束】
- 严禁直接出现“数学、物理、历史”等学科名称或学术术语。
- 严禁使用“讨厌、不喜欢、不感兴趣、避免”等否定性或情绪化词汇。
- 不得写成能力感知（如“我擅长…”）或情绪态度（如“我容易焦虑…”）的表述。
- 同一具体校园场景（如“考试准备”）不得在不同维度重复使用；若必须出现，必须从不同角度清晰区分，每个维度仅保留一次 （如S维度的“协助他人完成作业”与C维度的“按时完成作业”）。

【维度表现形式指南】
确保每个维度的 5 道题覆盖以下至少 3 个子类型，避免重复：

- R（现实型）：动手操作、工具/设备使用、户外/实践活动、维修/组装、身体协调任务  
- I（研究型）：观察/实验探究、数据/模式分析、问题解决、科学/逻辑思考、独立研究  
- A（艺术型）：创意表达、视觉/表演设计、故事/音乐创作、审美欣赏、独特风格探索  
- S（社会型）：帮助/指导他人、团队讨论、情感支持、教学/分享、社区互动  
- E（企业型）：组织/领导团队、说服/影响他人、推广展示创意、冒险决策、竞争性目标  
  【边界约束】必须包含影响他人或承担风险，禁止“学习计划、时间管理、个人复习目标”等表述
- C（常规型）：遵循规则/程序、数据整理、精确/重复任务、时间管理、系统维护  

【JSON 格式示例】
{
  "id": "int",              // 题号
  "dimension": "R" | "I" | "A" | "S" | "E" | "C", 
  "text": "string",            // 中文题干
}
`

var systemPromptFooter = `
【场景覆盖约束】  
- 每个维度/学科下的题目必须覆盖至少 3 种不同校园场景，不得集中在单一语境。  
- 校园场景示例（至少覆盖其三）：课堂学习、作业/复习、考试准备、实验探究、小组合作、社团活动、体育/艺术活动、同伴交往、家庭沟通、志愿服务。  
- 禁止使用高中课堂中极少出现的场景（如实地考察、原始文献、科研报告），题目必须基于常见的日常学习活动。
- 同一模块内不得出现高度重复的题干语境或措辞（如连续 3 道“按时完成作业”）。

【题干要求】
- 题干必须使用简洁自然的中文，适合高中生阅读；保持正式清晰的问卷语气，不得使用英文、拼音或外来词，不得过度学术化或网络化；禁止双重否定、引导性或价值判断。
- 所有题目使用1-5 Likert量表
- 所有题干必须严格基于中国高中生的校园生活与学习场景（如课堂学习、考试准备、完成作业、实验探究、学科竞赛、班级/社团活动、同伴关系、家庭沟通、志愿服务）。
- 严禁出现与成人工作、社会职场、财务或职业行为相关的情境。
- 所有学科题干必须贴合中国高一教学大纲，限定在基础知识、基本技能和常见学习任务上，不得超纲或大学化；语境需来源于课堂、作业、复习、考试等常见学习活动。  

【量表锚点要求】
- OCEAN / RIASEC：1=完全不符合，2=不太符合，3=一般，4=比较符合，5=完全符合
- ASC：1=非常不擅长，2=不太擅长，3=一般，4=比较擅长，5=非常擅长
- 必须严格按照对应模块的锚点表述，不得混用。

【输出格式要求】
- 仅以 JSON 对象数组输出，无任何解释。
- 所有字段必须完整填写；不得生成未定义字段。
- id 从 1 开始，连续编号。
`

// --- Prompt 组装（根据模块拼接） ---
func composeSystemPrompt(module TestTyp) (string, error) {
	var modulePrompt string
	switch module {
	case TypOCEAN:
		modulePrompt = systemPromptOCEAN
	case TypRIASEC:
		modulePrompt = systemPromptRIASEC
	case TypSEC:
		modulePrompt = systemPromptASC
	default:
		return "", fmt.Errorf("未知模块: %s", module)
	}
	return strings.TrimSpace(modulePrompt + "\n" + systemPromptFooter), nil
}
