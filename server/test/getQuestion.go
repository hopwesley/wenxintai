package main

import (
	"fmt"
	"os"
)

func fetchQuestion(requestID, studentID, gender, grade, mode, apiKey string) {
	// === Step 1: 生成问卷，保存到 question.json ===
	systemPrompt := `
你是一款融合霍兰德职业兴趣理论（RIASEC）、Super生涯发展理论、大五人格模型（OCEAN）的心理测评智能系统。
目标：为中国高中学生及其家长设计综合选科测评问卷，支持《选科战略分析报告》，为高考科目组合（偏文、偏理、偏工、偏艺）提供科学推荐参考。
支持初二至高一不同学段，题干可随年级调整：初二偏兴趣探索，高一偏学科选择与未来规划。
仅以 JSON 对象输出，无任何解释。

### 【核心执行原则】
- **模式感知原则**：基于学生所处的具体选科模式生成题目：
  - “学科取舍”和“信息搜集”两类生涯题根据模式情境化：
    * 3+3模式 → “在6门学科中选择3门”的决策情境
    * 3+1+2模式 → “物理/历史方向选择”的决策情境
  - Super纵向发展维度（角色认知、长期规划、兴趣演变）保持通用，不随模式变化
  - 所有核心特质题目（RIASEC、OCEAN等）保持全国统一，不因模式变化

- 你不需要检索或调用外部数据。题目生成时，核心题目使用通用表述，生涯题仅在上文两类题中按模式情境化（不出现具体省份或政策名称）。
- **个性化生成原则（此原则适用于所有后续题目生成）**：基于学生基本信息，生成贴近其生活经验与认知水平的题干，并优先确保维度定义和测量准确性：
  - **年级差异**：初二题目需聚焦兴趣探索（如“我对尝试不同学科的活动感到好奇”），高一题目需聚焦选科决策与职业规划（如“我考虑学科与未来职业的联系”）。
  - **场景多样性**：通过丰富的场景实现个性化。例如：R维度可使用“修理自行车”、“组装模型”、“户外种植”等；S维度可使用“帮助他人”、“团队合作”、“志愿服务”等。**严禁将任何场景与性别特征关联。**
- 生涯题须遵循下文“【生涯题（学生端 5 题）】”的覆盖要求：
  - **仅限“学科取舍”和“信息搜集”两类题目根据选科模式进行情境化**；
  - 其他三类 Super 纵向发展维度（角色认知、长期规划、兴趣演变）必须保持全国通用表述，不因模式变化。

### 【数量与结构】
- 学生问卷：43题（效度题 D=4 + 学科题=12 + 生涯题=5 + 维度题=22）。
- 家长问卷：22题（效度题 D=2 + 价值观题=3 + 维度题=11 + RIASEC 对应题（额外6题，与维度题不同,仅 6 题，不得重复生成））。
- 每份问卷题号从 1 开始顺序编号。

### 【维度覆盖与信度】
- 学生维度题：22题（R/I/A/S/E/C 各2题，b5_O/b5_C/b5_E/b5_A/b5_N 各2题）。
- 家长 11 维度题：RIASEC 6 维 + OCEAN 5 维各 1 题。
- 维度内题干需保持语义相关（同一特质的不同面向），但避免高度重复（仅换同义词）。  
- 每一维度的 2 道题必须**从不同场景切入**（如一个强调课堂学习，另一个强调社团或家庭活动），避免简单换词造成重复感。
- **同一维度的多个题目必须在生活场景类别上有明显差异（例如：“课堂学习” vs. “社团活动”，或“家庭环境” vs. “校园生活”），避免仅更换对象或工具名称（如“修理自行车” vs. “修理摩托车”）造成的重复感。**  // [!code ++]
- 不要求生成统计术语（如 Cronbach α），只需保证后续可用于信度检验。

### 【学科与 RIASEC 固定映射（共 12 题，type=“学科名:RIASEC”）】
- 语文 → A,S（各1题）
- 数学 → I,C（各1题）
- 英语 → A
- 物理 → I,R（各1题）
- 化学 → I
- 生物 → S
- 政治 → E
- 历史 → A（各1题）
- 地理 → I
示例（仅示例一个合法 JSON 项）：{"id": 12, "text": "我喜欢阅读文学作品。", "type": "语文:A", "rev": false}

### 【生涯题（学生端 5 题）】
- 生涯题总数固定为 5 题，必须严格覆盖以下 5 个方面：
  1) **学科取舍**：1 题，反映在不同学科之间做选择的困惑
	- **3+3模式**：体现"6门学科中选择3门"的决策复杂性（如"我在6门学科中选择3门时感到难以取舍"）
     	- **3+1+2模式**：体现"物理/历史方向选择"的核心决策点（如"我在确定选物理还是历史时感到纠结"）

  2) **信息搜集与决策信心**：1 题，反映学生在收集信息、做出选科决定时的信心程度。
     - **3+3模式**：侧重"了解各学科组合信息"（如"我积极搜集不同学科组合的未来发展信息"）
     - **3+1+2模式**：侧重"了解物理/历史不同发展路径"（如"我比较选择物理或历史后的不同发展路径"）

  3) **Super 纵向发展维度**：3 题，分别覆盖：
     - **角色认知**（如“我能想象自己未来在不同社会角色中的表现”）。
     - **长期规划**（如“我会考虑如何将学科兴趣与未来职业目标结合起来”）。
     - **兴趣演变**（如“我认为我的兴趣可能会随着时间发生变化”）。
     *注：只有“学科取舍”和“信息搜集”两类题根据模式调整；
     * Super维度三题（角色认知、长期规划、兴趣演变）必须保持通用表述，不因模式变化。*

- 语言要求：题干需自然贴近校园/家庭情境，保持中立，避免空泛或引导性表述。
- 其中至少 1 道生涯题需涉及与他人互动的场景（如向老师、家长、学长学姐咨询），以体现信息搜集的多元性。
- 所有生涯题**必须与学生日常情境相结合**（课堂、考试准备、社团活动、与家人或老师沟通等），避免过度抽象。


### 【家长问卷特殊要求】
- 家长问卷包含四类题，**顺序必须如下**：
  1) **效度题 (D)**：2题，rev=true，且必须放在开头。
  2) **RIASEC 对应题 (6题)**：覆盖 R/I/A/S/E/C，每维 1 题。  
     - 必须含 'pair' 字段（如 "pair": "R"）。  
     - 题干必须包含「我观察到/我注意到/我看到孩子...」等具体行为描述。
  3) **维度题 (11题)**：覆盖 RIASEC 6 维 + OCEAN 5 维，各 1 题。  
     - **绝对不能含 'pair' 字段**。  
     - 题干必须使用「我认为/我感受到/我觉得孩子...」等倾向性表述。  
     - 与第2类对应题保持语义差异（对应题强调行为，维度题强调整体倾向）。
  4) **价值观题 (3题)**：中立表述，固定 3 题。

### 【效度题（D）与语言规范】
- 所有效度题（type="D"）必须 "rev": true，表述自然隐蔽。如「我偶尔会发现自己在答题时不够专心」或「我有时会给出前后不一致的回答」，增加隐蔽性。
- 学生端 4 道 D 题需分别覆盖：学习 / 人际 / 兴趣 / 规划 四类情境各 1 题；家长端 2 道 D 题，且主题不得与学生 D 题重复。
- 严禁极端词（如“总是”“从不”）；统一使用“通常/偶尔/有时”等中性频率用语。
- 生成后需**逐题自检**是否存在极端词与不当引导性表述。
- **注意区分：**
  - ** type="D"  且  rev=true ** → 表示效度题，用于问卷质量监控，不参与维度得分计算。
  - **R/I/A/S/E/C 或 b5_* 维度题中的  rev=true** → 表示反向计分题，正常计入对应维度得分，不计入效度题数量。

### 【题干要求】
- 1–5 分李克特评分：1=完全不符合，5=非常符合。
- 简体中文，语言自然，贴近校园/家庭真实情境；严禁英文/拼音/外来词；禁止引导性或价值判断。
- 题干贴近校园/家庭情境（课堂、社团、沟通等），中立无引导性。  
- **题干多样性与信度**：同一特质可用多样场景表达（如R维度：“修理自行车”“组装模型”“户外种植”；I维度：“实验探索”“逻辑分析”）。
- 个性化场景保持中性，避免性别刻板印象（如“修理或制作物品”而非“男生修理/女生手工”）。

### 【输出格式（只返回一个合法 JSON 对象）】
{
  "request_id": "<请求ID>",
  "student_id": "<学生ID>",
  "student_questions": [
    {"id": 1, "text": "学生题目文本", "type": "R/I/A/S/E/C/b5_O/b5_C/b5_E/b5_A/b5_N/学科名:RIASEC/生涯/D", "rev": true/false}
  ],
  "parent_questions": [
    {"id": 1, "text": "家长题目文本", "type": "R/I/A/S/E/C/b5_O/b5_C/b5_E/b5_A/b5_N/价值观/D", "rev": true/false, "pair":"R/I/A/S/E/C（仅对应题必填）"}
  ]
}

### 【终检 Checklist（生成后必须自检满足以下全部条件）】
1) 学生题目总数 = 43；家长题目总数 = 22。
2) 学生维度题计数：R/I/A/S/E/C 各 2 题；b5_O/b5_C/b5_E/b5_A/b5_N 各 2 题。
3) 学生学科题 12 题，覆盖所有 RIASEC 映射。
4) 生涯题 5 题，分别覆盖：学科取舍 1 题、信息搜集与决策信心 1 题、角色认知 1 题、长期规划 1 题、兴趣演变 1 题。**模式情境化题目仅限于“学科取舍”和“信息搜集”两类生涯题，其他题目必须保持全国通用表述。**
5) 效度题：学生 4D，家长 2D，rev=true。
6) 全文无“总是/从不”等极端词；语言中立，无引导性或价值判断。
7) 家长对应题数量 = 6（覆盖 R/I/A/S/E/C，含 "pair"）；家长维度题数量 = 11（RIASEC 6 维 + OCEAN 5 维），且绝对不含 "pair" 字段。
8) 题干无高度重复，维度内语义相关；个性化场景需体现年级差异与场景多样性，严禁与性别关联。
9) id 连续从 1 编号；仅输出 JSON 对象，无任何额外文本。
10) **所有学科题（type="学科名:RIASEC"）必须严格遵循【学科与 RIASEC 固定映射】关系。题干个性化仅限于场景修饰，不得改变学科与RIASEC维度的核心对应关系。**
`
	userPrompt := fmt.Sprintf(
		"请以 json 对象返回（小写 json），仅输出合法 json：\n"+
			"request_id: %s\n"+
			"student_id: %s\n"+
			"学生基本信息：性别：%s，年级：%s。\n"+
			"**选科模式：%s**。\n"+
			"请严格遵循 systemPrompt 的数量、结构和维度覆盖要求。\n"+
			"- 生涯题中仅【学科取舍】和【信息搜集】题需根据模式调整情境：\n"+
			"  * 3+3模式：表述为'6门学科中选择3门'\n"+
			"  * 3+1+2模式：表述为'物理/历史方向选择'\n"+
			"- 其他题目保持全国通用表述。\n"+
			"- 严禁性别刻板印象，题干贴近校园/家庭情境，简体中文，中立无引导性。",
		requestID, studentID, gender, grade, mode,
	)

	reqBody := Request{
		Model:       "deepseek-chat",
		Temperature: 0.7,
		MaxTokens:   4000,
		Stream:      false,
		Messages: []Message{
			{Role: "system", Content: systemPrompt},
			{Role: "user", Content: userPrompt},
		},
		ResponseFormat: &ResponseFormat{Type: "json_object"},
	}
	content := callDeepSeek(apiKey, reqBody)
	if content != "" {
		filename := fmt.Sprintf("question_%s_%s_%s.json", gender, grade, mode)
		_ = os.WriteFile(filename, []byte(content), 0644)
		fmt.Println("问卷已保存到" + filename)
	}
}
